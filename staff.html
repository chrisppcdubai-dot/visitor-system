<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Portal - PPC Hybrid System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Work+Sans:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #0a0a0a;
            --secondary: #1a1a1a;
            --accent: #00ff88;
            --danger: #ff4444;
            --text: #ffffff;
            --text-dim: #a0a0a0;
            --border: #2a2a2a;
            --card-bg: #151515;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--text) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.5rem;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .nav-tab.active {
            background: var(--accent);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        input, select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .btn {
            background: var(--accent);
            color: var(--primary);
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--text);
        }

        .btn-block {
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border-top: 3px solid var(--accent);
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        .visitor-item {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .visitor-item.checked-out {
            border-left-color: var(--text-dim);
            opacity: 0.7;
        }

        .visitor-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .visitor-details {
            color: var(--text-dim);
            font-size: 0.9rem;
            line-height: 1.8;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.1);
            border-left-color: var(--accent);
            color: var(--accent);
        }

        .alert-error {
            background: rgba(255, 68, 68, 0.1);
            border-left-color: var(--danger);
            color: var(--danger);
        }

        .collapsible-section {
            margin-bottom: 2rem;
        }

        .collapsible-header {
            background: var(--secondary);
            padding: 1rem 1.5rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            border-color: var(--accent);
        }

        .collapsible-content {
            display: none;
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        .collapsible-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .nav-tabs {
                flex-direction: column;
            }
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîí Staff Portal</h1>
            <p class="subtitle">Hybrid Cloud System</p>
        </header>

        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="card" style="max-width: 400px; margin: 4rem auto;">
                <h2 style="margin-bottom: 1.5rem; text-align: center; font-family: 'JetBrains Mono', monospace;">Staff Login</h2>
                <div id="loginAlert"></div>
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="adminPassword" placeholder="Enter staff password" style="padding-right: 3.5rem;">
                        <button type="button" onclick="togglePassword('adminPassword', 'loginEye')" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; font-size: 1.5rem; color: var(--accent);">
                            <span id="loginEye">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <button onclick="staffLogin()" class="btn btn-block">Login</button>
                <p style="text-align: center; margin-top: 1rem;">
                    <a href="index.html" style="color: var(--accent); text-decoration: none;">‚Üê Back to Visitor Check-In</a>
                </p>
            </div>
        </div>

        <!-- Staff Panel -->
        <div id="staffPanel" style="display: none;">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="switchTab('current')">Current Visitors</button>
                <button class="nav-tab" onclick="switchTab('history')">History</button>
                <button class="nav-tab" onclick="switchTab('management')">Management</button>
                <button class="nav-tab" onclick="switchTab('settings')">Settings</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="currentCount">-</div>
                        <div class="stat-label">Currently In</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayCount">-</div>
                        <div class="stat-label">Today's Visitors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">-</div>
                        <div class="stat-label">Total Visitors</div>
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">Quick Actions</h2>
                    <div class="action-buttons">
                        <button onclick="switchTab('current')" class="btn">View Current Visitors</button>
                        <button onclick="refreshData()" class="btn btn-secondary">üîÑ Refresh Data</button>
                        <button onclick="checkEndOfDay()" class="btn btn-secondary">üìä Check End of Day</button>
                        <button onclick="exportData('today')" class="btn btn-secondary">üì• Export Today</button>
                        <button onclick="staffLogout()" class="btn btn-danger">Logout</button>
                    </div>
                </div>

                <!-- Google Sheets Config (Collapsed by default) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible('sheetsConfig')">
                        <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent);">‚òÅÔ∏è Cloud Configuration</span>
                        <span id="sheetsConfigIcon">‚ñº</span>
                    </div>
                    <div id="sheetsConfig" class="collapsible-content">
                        <div class="form-group">
                            <label>Web App URL</label>
                            <input type="text" id="webAppUrlInput" readonly style="background: var(--primary); color: var(--text-dim);">
                        </div>
                        <p style="color: var(--accent); font-size: 0.9rem;">‚úÖ System configured and connected to Google Sheets</p>
                    </div>
                </div>
            </div>

            <!-- Current Visitors Tab -->
            <div id="current" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">Currently Checked In</h2>
                    <div id="currentVisitorsList"></div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">Visitor History</h2>
                    <div class="action-buttons" style="margin-bottom: 1.5rem;">
                        <button onclick="filterHistory('today')" class="btn btn-secondary">Today</button>
                        <button onclick="filterHistory('week')" class="btn btn-secondary">This Week</button>
                        <button onclick="filterHistory('month')" class="btn btn-secondary">This Month</button>
                        <button onclick="filterHistory('all')" class="btn btn-secondary">All</button>
                        <button onclick="showClearMenu()" class="btn btn-danger">üóëÔ∏è Clear History</button>
                    </div>
                    <div id="historyList"></div>
                </div>
            </div>

            <!-- Management Tab -->
            <div id="management" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">üìã Staff Management</h2>
                    <div id="staffAlert"></div>
                    <table id="staffTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody"></tbody>
                    </table>
                    <button onclick="showAddStaffForm()" class="btn" style="margin-top: 1rem;">‚ûï Add Staff Member</button>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">üéØ Purpose Management</h2>
                    <div id="purposeAlert"></div>
                    <div id="purposeList"></div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label>Add New Purpose</label>
                        <input type="text" id="newPurpose" placeholder="Enter purpose name">
                    </div>
                    <button onclick="addPurpose()" class="btn">‚ûï Add Purpose</button>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">üîê Change Password</h2>
                    <div id="settingsAlert"></div>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <div style="position: relative;">
                                <input type="password" id="currentPassword" required style="padding-right: 3.5rem;">
                                <button type="button" onclick="togglePassword('currentPassword', 'currentEye')" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; font-size: 1.5rem; color: var(--accent);">
                                    <span id="currentEye">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <div style="position: relative;">
                                <input type="password" id="newPassword" required minlength="6" style="padding-right: 3.5rem;">
                                <button type="button" onclick="togglePassword('newPassword', 'newEye')" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; font-size: 1.5rem; color: var(--accent);">
                                    <span id="newEye">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <div style="position: relative;">
                                <input type="password" id="confirmPassword" required minlength="6" style="padding-right: 3.5rem;">
                                <button type="button" onclick="togglePassword('confirmPassword', 'confirmEye')" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; font-size: 1.5rem; color: var(--accent);">
                                    <span id="confirmEye">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn">Change Password</button>
                    </form>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">‚ÑπÔ∏è System Information</h2>
                    <div style="color: var(--text-dim); line-height: 2;">
                        <p><strong style="color: var(--accent);">System Type:</strong> Hybrid Cloud ‚òÅÔ∏è</p>
                        <p><strong style="color: var(--accent);">Data Storage:</strong> Google Sheets (Cloud)</p>
                        <p><strong style="color: var(--accent);">Multi-Device Support:</strong> ‚úÖ Enabled</p>
                        <p><strong style="color: var(--accent);">Features:</strong> Staff Management, Purpose Management, Notifications</p>
                        <p><strong style="color: var(--accent);">Version:</strong> 3.0 Hybrid</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwC4oUm3holztMyeFmPbfofAyLvZDg4bHrIsWgHHsfhpAwovC32eCOuva7fqEI-vKgo2Q/exec';
        
        let isLoggedIn = false;
        let cloudPassword = '';
        let allVisitors = [];
        let staffList = [];
        let purposesList = [];

        // Auto-configure
        if (!localStorage.getItem('webAppUrl')) {
            localStorage.setItem('webAppUrl', WEB_APP_URL);
        }

        // Password toggle
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà';
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è';
            }
        }

        // Staff login
        async function staffLogin() {
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch(`${WEB_APP_URL}?action=getPassword`);
                const data = await response.json();
                
                if (data.success && password === data.password) {
                    isLoggedIn = true;
                    cloudPassword = data.password;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('staffPanel').style.display = 'block';
                    document.getElementById('webAppUrlInput').value = WEB_APP_URL;
                    await loadAllData();
                } else {
                    showAlert('loginAlert', 'error', 'Incorrect password');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('loginAlert', 'error', 'Login failed. Check connection.');
            }
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadVisitors(),
                loadStaff(),
                loadPurposes()
            ]);
            updateDashboard();
            displayCurrentVisitors();
            displayHistory('all');
        }

        // Load visitors
        async function loadVisitors() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getVisitors`);
                const data = await response.json();
                if (data.success) {
                    allVisitors = data.visitors;
                }
            } catch (error) {
                console.error('Load visitors error:', error);
            }
        }

        // Load staff
        async function loadStaff() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getStaff`);
                const data = await response.json();
                if (data.success) {
                    staffList = data.staff;
                    displayStaffTable();
                }
            } catch (error) {
                console.error('Load staff error:', error);
            }
        }

        // Load purposes
        async function loadPurposes() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getPurposes`);
                const data = await response.json();
                if (data.success) {
                    purposesList = data.purposes;
                    displayPurposesList();
                }
            } catch (error) {
                console.error('Load purposes error:', error);
            }
        }

        // Update dashboard stats
        function updateDashboard() {
            const currentIn = allVisitors.filter(v => v.Status === 'IN').length;
            const today = new Date().toLocaleDateString('en-GB');
            const todayCount = allVisitors.filter(v => v.Date === today).length;
            
            document.getElementById('currentCount').textContent = currentIn;
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('totalCount').textContent = allVisitors.length;
        }

        // Display current visitors
        function displayCurrentVisitors() {
            const current = allVisitors.filter(v => v.Status === 'IN');
            const listDiv = document.getElementById('currentVisitorsList');
        
            if (current.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 2rem;">No visitors currently checked in</p>';
                return;
            }
        
            listDiv.innerHTML = current.map(v => {
                // Handle property names with spaces
                const date = v['Date '] || v['Date'] || v.Date || 'N/A';
                const time = v[' Check-In Time'] || v['Check-In Time'] || v['Check-In Time'] || '';
                
                // Format time if it's in ISO format
                let displayTime = time;
                if (time && time.includes('T')) {
                    const timeObj = new Date(time);
                    displayTime = timeObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                return `
                    <div class="visitor-item">
                        <div class="visitor-info">
                            <h3>${v['Full Name']}</h3>
                            <div class="visitor-details">
                                <p><strong>Company:</strong> ${v.Company}</p>
                                <p><strong>Phone:</strong> ${v.Phone}</p>
                                <p><strong>Visiting:</strong> ${v['Host Name']}</p>
                                <p><strong>Check-In:</strong> ${date} ${displayTime}</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button onclick="checkoutVisitor('${v['Visitor ID']}')" class="btn btn-secondary">Check Out</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Display history
        function displayHistory(filter) {
            let filtered = allVisitors;
            const today = new Date();
            const todayStr = today.toLocaleDateString('en-GB');
        
            if (filter === 'today') {
                const dateMatch = v => {
                    const vDate = v['Date '] || v['Date'] || v.Date || '';
                    return vDate.trim() === todayStr;
                };
                filtered = allVisitors.filter(dateMatch);
            } else if (filter === 'week') {
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                filtered = allVisitors.filter(v => {
                    const dateStr = (v['Date '] || v['Date'] || v.Date || '').trim();
                    if (!dateStr) return false;
                    const vDate = new Date(dateStr.split('/').reverse().join('-'));
                    return vDate >= weekAgo;
                });
            } else if (filter === 'month') {
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                filtered = allVisitors.filter(v => {
                    const dateStr = (v['Date '] || v['Date'] || v.Date || '').trim();
                    if (!dateStr) return false;
                    const vDate = new Date(dateStr.split('/').reverse().join('-'));
                    return vDate >= monthAgo;
                });
            }
        
            const listDiv = document.getElementById('historyList');
            const sorted = [...filtered].reverse();
        
            listDiv.innerHTML = sorted.map(v => {
                // Handle property names with spaces
                const date = v['Date '] || v['Date'] || v.Date || 'N/A';
                const checkInTime = v[' Check-In Time'] || v['Check-In Time'] || '';
                const checkOutTime = v[' Check-Out Time'] || v['Check-Out Time'] || '';
                
                // Format times if in ISO format
                let displayCheckIn = checkInTime;
                if (checkInTime && checkInTime.includes('T')) {
                    const timeObj = new Date(checkInTime);
                    displayCheckIn = timeObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                let displayCheckOut = checkOutTime;
                if (checkOutTime && checkOutTime.includes('T')) {
                    const timeObj = new Date(checkOutTime);
                    displayCheckOut = timeObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                return `
                    <div class="visitor-item ${v.Status === 'OUT' ? 'checked-out' : ''}">
                        <div class="visitor-info">
                            <h3>${v['Full Name']} (${v['Visitor ID']})</h3>
                            <div class="visitor-details">
                                <p><strong>Company:</strong> ${v.Company}</p>
                                <p><strong>Check-In:</strong> ${date} ${displayCheckIn}</p>
                                ${displayCheckOut ? `<p><strong>Check-Out:</strong> ${displayCheckOut}</p>` : ''}
                                <p><strong>Status:</strong> ${v.Status}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Display staff table
        function displayStaffTable() {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = staffList.map(s => `
                <tr>
                    <td>${s.Name}</td>
                    <td>${s.Phone || '-'}</td>
                    <td>${s.Email || '-'}</td>
                    <td>
                        <button onclick="editStaff('${s.Name}')" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.8rem;">Edit</button>
                        <button onclick="deleteStaff('${s.Name}')" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.8rem; margin-left: 0.5rem;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Display purposes list
        function displayPurposesList() {
            const listDiv = document.getElementById('purposeList');
            listDiv.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                    ${purposesList.map(p => `
                        <span style="background: var(--secondary); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid var(--border); display: inline-flex; align-items: center; gap: 0.5rem;">
                            ${p}
                            <button onclick="deletePurpose('${p}')" style="background: transparent; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem;">√ó</button>
                        </span>
                    `).join('')}
                </div>
            `;
        }

        // Add purpose
        async function addPurpose() {
            const input = document.getElementById('newPurpose');
            const purpose = input.value.trim();
            
            if (!purpose) {
                alert('Please enter a purpose name');
                return;
            }

            if (purposesList.includes(purpose)) {
                alert('This purpose already exists');
                return;
            }

            purposesList.push(purpose);
            
            try {
                const response = await fetch(`${WEB_APP_URL}?action=updatePurposes&data=${encodeURIComponent(JSON.stringify(purposesList))}`);
                const data = await response.json();
                
                if (data.success) {
                    showAlert('purposeAlert', 'success', 'Purpose added successfully');
                    input.value = '';
                    displayPurposesList();
                }
            } catch (error) {
                console.error('Add purpose error:', error);
                alert('Failed to add purpose');
            }
        }

        // Delete purpose
        async function deletePurpose(purpose) {
            if (!confirm(`Delete purpose: ${purpose}?`)) return;

            purposesList = purposesList.filter(p => p !== purpose);
            
            try {
                const response = await fetch(`${WEB_APP_URL}?action=updatePurposes&data=${encodeURIComponent(JSON.stringify(purposesList))}`);
                const data = await response.json();
                
                if (data.success) {
                    showAlert('purposeAlert', 'success', 'Purpose deleted successfully');
                    displayPurposesList();
                }
            } catch (error) {
                console.error('Delete purpose error:', error);
                alert('Failed to delete purpose');
            }
        }

        // Show add staff form
        function showAddStaffForm() {
            const name = prompt('Enter staff name:');
            if (!name) return;
            
            const phone = prompt('Enter phone number (optional):');
            const email = prompt('Enter email (optional):');
            
            staffList.push({ Name: name, Phone: phone || '', Email: email || '' });
            updateStaffList();
        }

        // Edit staff
        function editStaff(name) {
            const staff = staffList.find(s => s.Name === name);
            if (!staff) return;
            
            const newPhone = prompt('Enter phone number:', staff.Phone);
            const newEmail = prompt('Enter email:', staff.Email);
            
            staff.Phone = newPhone || '';
            staff.Email = newEmail || '';
            
            updateStaffList();
        }

        // Delete staff
        async function deleteStaff(name) {
            if (!confirm(`Delete staff member: ${name}?`)) return;
            
            staffList = staffList.filter(s => s.Name !== name);
            updateStaffList();
        }

        // Update staff list in cloud
        async function updateStaffList() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=updateStaff&data=${encodeURIComponent(JSON.stringify(staffList))}`);
                const data = await response.json();
                
                if (data.success) {
                    showAlert('staffAlert', 'success', 'Staff list updated successfully');
                    displayStaffTable();
                }
            } catch (error) {
                console.error('Update staff error:', error);
                alert('Failed to update staff list');
            }
        }

        // Checkout visitor
        async function checkoutVisitor(visitorId) {
            if (!confirm('Check out this visitor?')) return;

            try {
                const checkoutTime = new Date().toLocaleTimeString('en-US', { hour12: false });
                const response = await fetch(`${WEB_APP_URL}?action=checkout&visitorId=${visitorId}&checkoutTime=${checkoutTime}`);
                
                alert('‚úÖ Visitor checked out successfully!');
                await loadAllData();
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Failed to checkout visitor');
            }
        }

        // Refresh data
        async function refreshData() {
            await loadAllData();
            alert('‚úÖ Data refreshed!');
        }

        // Check end of day
        function checkEndOfDay() {
            const current = allVisitors.filter(v => v.Status === 'IN');
            
            if (current.length === 0) {
                alert('‚úÖ All visitors have checked out!\n\nEnd of day complete.');
                return;
            }
            
            // Show end of day modal with checkout options
            const modal = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; overflow-y: auto; padding: 2rem;" onclick="if(event.target === this) closeEndOfDay()">
                    <div style="background: var(--card-bg); border: 2px solid var(--warning); border-radius: 12px; padding: 2rem; max-width: 900px; margin: 0 auto;" onclick="event.stopPropagation()">
                        <h2 style="color: var(--warning); margin-bottom: 1rem; text-align: center; font-family: 'JetBrains Mono', monospace;">üìä End of Day Report</h2>
                        
                        <p style="color: var(--text); text-align: center; margin-bottom: 1.5rem;">
                            ‚ö†Ô∏è <strong>${current.length} visitor(s)</strong> still checked in
                        </p>
                        
                        <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="selectAllEndOfDay()" class="btn btn-secondary">Select All</button>
                            <button onclick="deselectAllEndOfDay()" class="btn btn-secondary">Deselect All</button>
                        </div>
                        
                        <div id="endOfDayList" style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem;">
                            ${current.map((v, index) => {
                                const date = v['Date '] || v['Date'] || v.Date || 'N/A';
                                const time = v[' Check-In Time'] || v['Check-In Time'] || '';
                                let displayTime = time;
                                if (time && time.includes('T')) {
                                    const timeObj = new Date(time);
                                    displayTime = timeObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
                                }
                                
                                return `
                                    <div style="background: var(--secondary); border: 1px solid var(--border); border-left: 4px solid var(--warning); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem;">
                                        <input type="checkbox" id="eod_${index}" data-visitor-id="${v['Visitor ID']}" class="eod-checkbox" style="width: 20px; height: 20px; cursor: pointer;">
                                        <label for="eod_${index}" style="flex: 1; cursor: pointer; margin: 0; color: var(--text); text-transform: none; letter-spacing: normal; font-family: 'Work Sans', sans-serif;">
                                            <div style="font-weight: bold; font-size: 1rem; margin-bottom: 0.25rem;">${v['Full Name']}</div>
                                            <div style="font-size: 0.85rem; color: var(--text-dim);">
                                                ${v.Company} ‚Ä¢ Check-In: ${date} ${displayTime}
                                            </div>
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button onclick="checkoutSelectedEOD()" class="btn" style="flex: 1;">
                                ‚úì Check Out Selected
                            </button>
                            <button onclick="checkoutAllEOD()" class="btn btn-danger" style="flex: 1;">
                                ‚úì Check Out All
                            </button>
                            <button onclick="closeEndOfDay()" class="btn btn-secondary" style="flex: 1;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', `<div id="endOfDayModal">${modal}</div>`);
        }
        
        // Select all end of day checkboxes
        function selectAllEndOfDay() {
            document.querySelectorAll('.eod-checkbox').forEach(cb => cb.checked = true);
        }
        
        // Deselect all end of day checkboxes
        function deselectAllEndOfDay() {
            document.querySelectorAll('.eod-checkbox').forEach(cb => cb.checked = false);
        }
        
        // Checkout selected visitors (end of day)
        async function checkoutSelectedEOD() {
            const checkboxes = document.querySelectorAll('.eod-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('‚ö†Ô∏è No visitors selected');
                return;
            }
            
            if (!confirm(`Check out ${checkboxes.length} selected visitor(s)?`)) {
                return;
            }
            
            const visitorIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-visitor-id'));
            const checkoutTime = new Date().toLocaleTimeString('en-US', { hour12: false });
            
            let successCount = 0;
            let failCount = 0;
            
            for (const visitorId of visitorIds) {
                try {
                    await fetch(`${WEB_APP_URL}?action=checkout&visitorId=${visitorId}&checkoutTime=${checkoutTime}`);
                    successCount++;
                } catch (error) {
                    console.error('Checkout error:', error);
                    failCount++;
                }
            }
            
            alert(`‚úÖ ${successCount} visitor(s) checked out successfully!${failCount > 0 ? `\n‚ùå ${failCount} failed` : ''}`);
            closeEndOfDay();
            await loadAllData();
        }
        
        // Checkout all visitors (end of day)
        async function checkoutAllEOD() {
            const current = allVisitors.filter(v => v.Status === 'IN');
            
            if (!confirm(`‚ö†Ô∏è Check out ALL ${current.length} visitors?\n\nThis will end the day and close all open visits.`)) {
                return;
            }
            
            const checkoutTime = new Date().toLocaleTimeString('en-US', { hour12: false });
            
            let successCount = 0;
            let failCount = 0;
            
            for (const visitor of current) {
                try {
                    await fetch(`${WEB_APP_URL}?action=checkout&visitorId=${visitor['Visitor ID']}&checkoutTime=${checkoutTime}`);
                    successCount++;
                } catch (error) {
                    console.error('Checkout error:', error);
                    failCount++;
                }
            }
            
            alert(`‚úÖ End of Day Complete!\n\n${successCount} visitor(s) checked out.${failCount > 0 ? `\n‚ùå ${failCount} failed` : ''}`);
            closeEndOfDay();
            await loadAllData();
        }
        
        // Close end of day modal
        function closeEndOfDay() {
            const modal = document.getElementById('endOfDayModal');
            if (modal) {
                modal.remove();
            }
        }

        // Export data
        function exportData(period) {
            let data = allVisitors;
            const today = new Date().toLocaleDateString('en-GB');
            
            if (period === 'today') {
                data = allVisitors.filter(v => v.Date === today);
            }

            const csv = [
                ['Date', 'Check-In Time', 'Full Name', 'Visitor ID', 'Phone', 'Email', 'Company', 'Host Name', 'Host Company', 'Purpose', 'Vehicle', 'Check-Out Time', 'Status'],
                ...data.map(v => [v.Date, v['Check-In Time'], v['Full Name'], v['Visitor ID'], v.Phone, v.Email, v.Company, v['Host Name'], v['Host Company'], v.Purpose, v.Vehicle, v['Check-Out Time'] || '', v.Status])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PPC-visitors-${period}-${today.replace(/\//g, '-')}.csv`;
            a.click();
        }

        // Password change
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (current !== cloudPassword) {
                showAlert('settingsAlert', 'error', 'Current password is incorrect');
                return;
            }

            if (newPass !== confirm) {
                showAlert('settingsAlert', 'error', 'New passwords do not match');
                return;
            }

            try {
                const response = await fetch(`${WEB_APP_URL}?action=updatePassword&password=${encodeURIComponent(newPass)}`);
                const data = await response.json();
                
                if (data.success) {
                    cloudPassword = newPass;
                    showAlert('settingsAlert', 'success', '‚úÖ Password changed! All devices will use the new password.');
                    document.getElementById('passwordForm').reset();
                }
            } catch (error) {
                console.error('Password change error:', error);
                showAlert('settingsAlert', 'error', 'Failed to change password');
            }
        });

        // Toggle collapsible
        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(id + 'Icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('active');
                icon.textContent = '‚ñ≤';
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const navTabs = document.querySelectorAll('.nav-tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'current') {
                displayCurrentVisitors();
            } else if (tabName === 'history') {
                displayHistory('all');
            }
        }

        // Filter history
        function filterHistory(period) {
            displayHistory(period);
        }

        // Staff logout
        function staffLogout() {
            isLoggedIn = false;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('staffPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        // Show alert
        function showAlert(elementId, type, message) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
        // Show clear menu
        function showClearMenu() {
            const menu = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;" onclick="if(event.target === this) closeClearMenu()">
                    <div style="background: var(--card-bg); border: 2px solid var(--danger); border-radius: 12px; padding: 2rem; max-width: 500px; width: 100%;" onclick="event.stopPropagation()">
                        <h2 style="color: var(--danger); margin-bottom: 1.5rem; text-align: center; font-family: 'JetBrains Mono', monospace;">üóëÔ∏è Clear History</h2>
                        
                        <p style="color: var(--text-dim); margin-bottom: 1.5rem; text-align: center;">Select what to delete:</p>
                        
                        <div style="display: grid; gap: 1rem;">
                            <button onclick="showManualSelection()" class="btn btn-secondary btn-block">
                                ‚úì Manual Selection (Pick Specific Records)
                            </button>
                            
                            <button onclick="clearHistory('today')" class="btn btn-secondary btn-block">
                                Clear Today's Records
                            </button>
                            
                            <button onclick="clearHistory('week')" class="btn btn-secondary btn-block">
                                Clear This Week's Records
                            </button>
                            
                            <button onclick="clearHistory('month')" class="btn btn-secondary btn-block">
                                Clear This Month's Records
                            </button>
                            
                            <button onclick="clearHistory('checkedout')" class="btn btn-secondary btn-block">
                                Clear All Checked-Out Visitors
                            </button>
                            
                            <button onclick="clearHistory('all')" class="btn btn-danger btn-block">
                                ‚ö†Ô∏è Clear ALL History
                            </button>
                            
                            <button onclick="closeClearMenu()" class="btn btn-secondary btn-block">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', `<div id="clearMenuModal">${menu}</div>`);
        }
        
        // Show manual selection screen
        function showManualSelection() {
            closeClearMenu();
            
            const selectionScreen = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; overflow-y: auto; padding: 2rem;" onclick="if(event.target === this) closeManualSelection()">
                    <div style="background: var(--card-bg); border: 2px solid var(--accent); border-radius: 12px; padding: 2rem; max-width: 900px; margin: 0 auto;" onclick="event.stopPropagation()">
                        <h2 style="color: var(--accent); margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">‚úì Select Records to Delete</h2>
                        
                        <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button onclick="selectAllRecords()" class="btn btn-secondary">Select All</button>
                            <button onclick="deselectAllRecords()" class="btn btn-secondary">Deselect All</button>
                            <button onclick="selectCheckedOut()" class="btn btn-secondary">Select Checked-Out Only</button>
                        </div>
                        
                        <div id="selectionList" style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem;"></div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="deleteSelectedRecords()" class="btn btn-danger" style="flex: 1;">
                                Delete Selected Records
                            </button>
                            <button onclick="closeManualSelection()" class="btn btn-secondary" style="flex: 1;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', `<div id="manualSelectionModal">${selectionScreen}</div>`);
            
            renderSelectionList();
        }
        
        // Render selection list with checkboxes
        function renderSelectionList() {
            const listDiv = document.getElementById('selectionList');
            const sorted = [...allVisitors].reverse(); // Most recent first
            
            if (sorted.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 2rem;">No records to display</p>';
                return;
            }
            
            listDiv.innerHTML = sorted.map((v, index) => `
                <div style="background: var(--secondary); border: 1px solid var(--border); border-left: 4px solid ${v.Status === 'IN' ? 'var(--accent)' : 'var(--text-dim)'}; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem;">
                    <input type="checkbox" id="record_${index}" data-visitor-id="${v['Visitor ID']}" style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="record_${index}" style="flex: 1; cursor: pointer; margin: 0; color: var(--text); text-transform: none; letter-spacing: normal; font-family: 'Work Sans', sans-serif;">
                        <div style="font-weight: bold; font-size: 1rem; margin-bottom: 0.25rem;">${v['Full Name']}</div>
                        <div style="font-size: 0.85rem; color: var(--text-dim);">
                            ${v.Company} ‚Ä¢ ${v.Date} ${v['Check-In Time']} ‚Ä¢ ${v.Status}
                            ${v['Check-Out Time'] ? ` ‚Üí ${v['Check-Out Time']}` : ''}
                        </div>
                    </label>
                </div>
            `).join('');
        }
        
        // Select all records
        function selectAllRecords() {
            document.querySelectorAll('#selectionList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }
        
        // Deselect all records
        function deselectAllRecords() {
            document.querySelectorAll('#selectionList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }
        
        // Select only checked-out records
        function selectCheckedOut() {
            deselectAllRecords();
            allVisitors.forEach((v, index) => {
                if (v.Status === 'OUT') {
                    const cb = document.getElementById(`record_${allVisitors.length - 1 - index}`);
                    if (cb) cb.checked = true;
                }
            });
        }
        
        // Delete selected records
        async function deleteSelectedRecords() {
            const checkboxes = document.querySelectorAll('#selectionList input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('‚ö†Ô∏è No records selected');
                return;
            }
            
            if (!confirm(`Delete ${checkboxes.length} selected record(s)?`)) {
                return;
            }
            
            const visitorIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-visitor-id'));
            
            try {
                const response = await fetch(`${WEB_APP_URL}?action=clearVisitors&clearType=manual&visitorIds=${encodeURIComponent(JSON.stringify(visitorIds))}`);
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ ${checkboxes.length} record(s) deleted successfully!`);
                    closeManualSelection();
                    await loadAllData();
                } else {
                    alert('‚ùå Failed to delete records: ' + data.error);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå Failed to delete records. Please try again.');
            }
        }
        
        // Close manual selection
        function closeManualSelection() {
            const modal = document.getElementById('manualSelectionModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Close clear menu
        function closeClearMenu() {
            const modal = document.getElementById('clearMenuModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Clear history by type
        async function clearHistory(clearType) {
            const messages = {
                'today': "Clear today's records?",
                'week': "Clear this week's records?",
                'month': "Clear this month's records?",
                'checkedout': "Clear all checked-out visitors?",
                'all': "‚ö†Ô∏è WARNING: Delete ALL visitor history?\n\nThis cannot be undone!"
            };
            
            const confirmMsg = messages[clearType] || 'Delete selected records?';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Extra confirmation for 'all'
            if (clearType === 'all') {
                if (!confirm('FINAL CONFIRMATION: Delete ALL data?')) {
                    return;
                }
            }
            
            try {
                const response = await fetch(`${WEB_APP_URL}?action=clearVisitors&clearType=${clearType}`);
                const data = await response.json();
                
                if (data.success) {
                    const successMessages = {
                        'today': "‚úÖ Today's records cleared!",
                        'week': "‚úÖ This week's records cleared!",
                        'month': "‚úÖ This month's records cleared!",
                        'checkedout': "‚úÖ All checked-out visitors cleared!",
                        'all': "‚úÖ All history cleared!"
                    };
                    
                    alert(successMessages[clearType] || '‚úÖ Records cleared!');
                    closeClearMenu();
                    await loadAllData();
                } else {
                    alert('‚ùå Failed to clear data: ' + data.error);
                }
            } catch (error) {
                console.error('Clear history error:', error);
                alert('‚ùå Failed to clear data. Please try again.');
            }
        }
    
    </script>
</body>
</html>

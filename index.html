<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Check-In - PPC</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Work+Sans:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0a0a0a;
            --secondary: #1a1a1a;
            --accent: #00ff88;
            --accent-dim: #00cc6a;
            --text: #ffffff;
            --text-dim: #a0a0a0;
            --border: #2a2a2a;
            --card-bg: #151515;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Work Sans', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 255, 136, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 255, 136, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--accent) 0%, var(--text) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1rem;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--accent);
            color: var(--primary);
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'Work Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
            background: var(--primary);
        }

        select {
            cursor: pointer;
        }

        .btn {
            background: var(--accent);
            color: var(--primary);
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-block {
            width: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .badge-preview {
            background: white;
            color: black;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            border: 2px solid var(--accent);
        }

        .badge-preview h3 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .badge-preview h2 {
            color: black;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .badge-preview p {
            color: #666;
            margin: 0.25rem 0;
            font-size: 0.95rem;
        }

        .badge-preview hr {
            border: none;
            border-top: 1px solid #ccc;
            margin: 1rem 0;
        }

        #qrcode {
            margin: 1rem 0;
            display: flex;
            justify-content: center;
        }

        .action-buttons {
            display: grid;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .search-box {
            margin-bottom: 1.5rem;
        }

        .visitor-item {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .visitor-item.checked-out {
            border-left-color: var(--text-dim);
            opacity: 0.7;
        }

        .visitor-info h3 {
            color: var(--text);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .visitor-details {
            color: var(--text-dim);
            font-size: 0.9rem;
            line-height: 1.8;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .badge-preview, .badge-preview * {
                visibility: visible;
            }
            .badge-preview {
                position: absolute;
                top: 0;
                left: 0;
                width: 10cm;
                height: 6.5cm;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            h1 {
                font-size: 2rem;
            }
            .nav-tabs {
                flex-direction: column;
            }
            .nav-tab {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üëã Visitor Check-In</h1>
            <p class="subtitle">Plastic Powder Coating Company</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('newVisitor')">New Visitor</button>
            <button class="nav-tab" onclick="switchTab('quickCheckin')">Quick Check-In</button>
            <button class="nav-tab" onclick="switchTab('checkout')">Check Out</button>
        </div>

        <!-- NEW VISITOR TAB -->
        <div id="newVisitor" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">New Visitor Registration</h2>
                <form id="newVisitorForm">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" required>
                    </div>

                    <div class="form-group">
                        <label for="company">Company *</label>
                        <input type="text" id="company" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email (Optional)</label>
                        <input type="email" id="email">
                    </div>

                    <div class="form-group">
                        <label for="hostName">Visiting (Host Name) *</label>
                        <select id="hostName" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="purpose">Purpose of Visit *</label>
                        <select id="purpose" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="vehicle">Vehicle Details (Optional)</label>
                        <input type="text" id="vehicle" placeholder="e.g., DXB-12345">
                    </div>

                    <button type="submit" class="btn btn-block">Check In & Generate Badge</button>
                </form>

                <button onclick="window.location.href='staff.html'" class="btn btn-secondary btn-block" style="margin-top: 1rem;">
                    üîí Staff Portal
                </button>
            </div>
        </div>

        <!-- QUICK CHECK-IN TAB -->
        <div id="quickCheckin" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">Quick Check-In</h2>
                <p style="color: var(--text-dim); margin-bottom: 1.5rem;">For returning visitors - search by name or phone</p>
                
                <div class="form-group">
                    <label for="quickSearch">Search by Name or Phone</label>
                    <input type="text" id="quickSearch" placeholder="Enter name or phone number">
                </div>
        
                <button onclick="quickCheckin()" class="btn btn-block">Search & Check In</button>
        
                <div id="quickResult" style="margin-top: 1.5rem;"></div>
            </div>
        </div>

        <!-- CHECK OUT TAB -->
        <div id="checkout" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">Check Out Visitor</h2>
                
                <!-- QR Scanner Section -->
                <div style="background: var(--secondary); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 1rem; margin-bottom: 1rem;">üì∑ Scan Badge QR Code</h3>
                    
                    <div id="qrScanner" style="display: none; margin-bottom: 1rem;">
                        <video id="qrVideo" style="width: 100%; max-width: 400px; border-radius: 8px; margin: 0 auto; display: block;"></video>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button onclick="startQRScanner()" class="btn" id="startScanBtn">
                            üì∑ Start QR Scanner
                        </button>
                        <button onclick="stopQRScanner()" class="btn btn-secondary" id="stopScanBtn" style="display: none;">
                            ‚èπÔ∏è Stop Scanner
                        </button>
                    </div>
                    
                    <p style="color: var(--text-dim); font-size: 0.85rem; margin-top: 1rem;">
                        üí° Point camera at the QR code on visitor's badge
                    </p>
                </div>
                
                <!-- Manual Search Section -->
                <div style="background: var(--secondary); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 1rem; margin-bottom: 1rem;">üîç Manual Search</h3>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="searchCheckout">Search by Name, Phone, or Visitor ID</label>
                        <input type="text" id="searchCheckout" placeholder="Enter name, phone number, or visitor ID..." oninput="searchForCheckout()">
                    </div>
                </div>
        
                <div id="checkoutList"></div>
            </div>
        </div>
    </div>

    <!-- Badge Modal -->
    <div id="badgeModal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--accent); margin-bottom: 1rem; text-align: center;">Visitor Badge Generated</h2>
            
            <div class="badge-preview" id="badgeContent">
                <h3>Guest Card</h3>
                <p id="badgeDateTime" style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;"></p>
                <h2 id="badgeName"></h2>
                <p id="badgeCompany"></p>
                <p id="badgeHost" style="font-weight: bold; color: #333; margin-top: 0.5rem;"></p>
                <hr>
                <p style="font-weight: bold;">Plastic Powder Coating Company LLC</p>
                <div id="qrcode"></div>
                <p style="font-size: 0.8rem; color: #666;">Please return this ticket when you leave. Have a nice day and welcome back!</p>
                <p style="font-size: 0.75rem; color: #999;">Visitor ID: <span id="badgeId"></span></p>
            </div>

            <div class="action-buttons">
                <button onclick="downloadPDF()" class="btn">üìÑ Save PDF</button>
                <button onclick="printBadge()" class="btn btn-secondary">üñ®Ô∏è Save & Print</button>
                <button onclick="emailVisitor()" class="btn btn-secondary">üìß Email Visitor</button>
                <button onclick="sendToVisitorMobile()" class="btn btn-secondary">üì± Send to Visitor</button>
                <button onclick="closeModal()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        // Configuration
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwC4oUm3holztMyeFmPbfofAyLvZDg4bHrIsWgHHsfhpAwovC32eCOuva7fqEI-vKgo2Q/exec';
        
        let currentVisitor = null;
        let allVisitors = [];
        let staffList = [];
        let purposesList = [];

        // Auto-configure on load
        if (!localStorage.getItem('webAppUrl')) {
            localStorage.setItem('webAppUrl', WEB_APP_URL);
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', async function() {
            await loadStaffList();
            await loadPurposesList();
            await loadVisitors();
        });

        // Load staff list from Google Sheets
        async function loadStaffList() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getStaff`);
                const data = await response.json();
                
                if (data.success) {
                    staffList = data.staff;
                    const select = document.getElementById('hostName');
                    select.innerHTML = '<option value="">Select host...</option>';
                    staffList.forEach(staff => {
                        select.innerHTML += `<option value="${staff.Name}" data-phone="${staff.Phone}" data-email="${staff.Email}">${staff.Name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }

        // Load purposes list from Google Sheets
        async function loadPurposesList() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getPurposes`);
                const data = await response.json();
                
                if (data.success) {
                    purposesList = data.purposes;
                    const select = document.getElementById('purpose');
                    select.innerHTML = '<option value="">Select purpose...</option>';
                    purposesList.forEach(purpose => {
                        select.innerHTML += `<option value="${purpose}">${purpose}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading purposes:', error);
            }
        }

        // Load all visitors from Google Sheets
        async function loadVisitors() {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getVisitors`);
                const data = await response.json();
                
                if (data.success) {
                    allVisitors = data.visitors;
                }
            } catch (error) {
                console.error('Error loading visitors:', error);
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const navTabs = document.querySelectorAll('.nav-tab');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'checkout') {
                displayCheckoutList();
            }
        }

        // New visitor form submission
        document.getElementById('newVisitorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const hostSelect = document.getElementById('hostName');
            const selectedHost = hostSelect.options[hostSelect.selectedIndex];
            
            const visitor = {
                fullName: document.getElementById('fullName').value,
                company: document.getElementById('company').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value || '',
                hostName: hostSelect.value,
                hostPhone: selectedHost.getAttribute('data-phone') || '',
                hostEmail: selectedHost.getAttribute('data-email') || '',
                hostCompany: 'Plastic Powder Coating Company LLC',
                purpose: document.getElementById('purpose').value,
                vehicle: document.getElementById('vehicle').value || '',
                id: 'VIS-' + Date.now(),
                checkInTime: new Date().toISOString(),
                checkOutTime: '',
                status: 'IN'
            };

            try {
                await syncToCloud(visitor);
                currentVisitor = visitor;
                generateBadge(visitor);
                document.getElementById('newVisitorForm').reset();
                await loadVisitors(); // Refresh visitor list
            } catch (error) {
                console.error('Check-in error:', error);
                alert('‚ùå Check-in failed. Please try again.');
            }
        });

        // Sync visitor to cloud (Google Sheets)
        async function syncToCloud(visitor) {
            const checkInDate = new Date(visitor.checkInTime);
            const data = {
                date: checkInDate.toLocaleDateString('en-GB'),
                checkInTime: checkInDate.toLocaleTimeString('en-US', { hour12: false }),
                fullName: visitor.fullName,
                visitorId: visitor.id,
                phone: visitor.phone,
                email: visitor.email,
                company: visitor.company,
                hostName: visitor.hostName,
                hostCompany: visitor.hostCompany,
                purpose: visitor.purpose,
                vehicle: visitor.vehicle,
                checkOutTime: '',
                status: visitor.status
            };

            console.log('üì§ Syncing to cloud:', data);

            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            console.log('‚úÖ Synced to cloud');
        }

        // Generate badge
        function generateBadge(visitor) {
            const checkInDate = new Date(visitor.checkInTime);
            
            document.getElementById('badgeName').textContent = visitor.fullName;
            document.getElementById('badgeCompany').textContent = visitor.company;
            
            // Format: "05.02.2026 10:55"
            const dateStr = checkInDate.toLocaleDateString('en-GB').replace(/\//g, '.');
            const timeStr = checkInDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            document.getElementById('badgeDateTime').textContent = `${dateStr} ${timeStr}`;
            
            document.getElementById('badgeHost').textContent = visitor.hostName ? `- ${visitor.hostName}` : '-';
            document.getElementById('badgeId').textContent = visitor.id;
        
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            new QRCode(qrDiv, {
                text: visitor.id,
                width: 128,
                height: 128
            });
        
            document.getElementById('badgeModal').classList.add('active');
            
            // Auto-send notifications
            setTimeout(() => {
                sendNotificationsAuto(visitor);
            }, 500);
        }
        
        // Auto-send notifications (separate function)
        function sendNotificationsAuto(visitor) {
            if (!visitor.hostEmail && !visitor.hostPhone) {
                console.log('No host contact info available');
                return;
            }
        
            const message = `üîî Visitor Alert!\n\n${visitor.fullName} from ${visitor.company} is here to see you.\n\nPurpose: ${visitor.purpose}\nTime: ${new Date().toLocaleString()}\n\nPlease come to reception.\n\n- PPC Reception`;
        
            // WhatsApp notification
            if (visitor.hostPhone) {
                const whatsappUrl = `https://wa.me/${visitor.hostPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank', 'width=600,height=400');
            }
        
            // Email notification  
            if (visitor.hostEmail) {
                const subject = `Visitor Alert: ${visitor.fullName} from ${visitor.company}`;
                const mailtoUrl = `mailto:${visitor.hostEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
                setTimeout(() => {
                    window.location.href = mailtoUrl;
                }, 1000);
            }
        }

        // Download PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const badge = document.getElementById('badgeContent');
            
            const canvas = await html2canvas(badge, {
                scale: 2,
                backgroundColor: '#ffffff'
            });
            
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'cm',
                format: [10, 6.5]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, 10, 6.5);
            pdf.save(`visitor-badge-${currentVisitor.fullName.replace(/\s+/g, '-')}.pdf`);
        }

        // Print badge
        function printBadge() {
            downloadPDF();
            setTimeout(() => {
                alert('‚úÖ Badge saved as PDF!\n\nNext step:\n1. Open the downloaded PDF\n2. Click Print from PDF viewer\n3. Print on 10cm x 6.5cm badge paper');
            }, 500);
        }

        // Send notifications to host
        function sendNotifications() {
            if (!currentVisitor.hostEmail && !currentVisitor.hostPhone) {
                alert('‚ö†Ô∏è No contact information available for host.\n\nPlease add phone/email in Staff Management.');
                return;
            }

            const message = `üîî Visitor Alert!\n\n${currentVisitor.fullName} from ${currentVisitor.company} is here to see you.\n\nPurpose: ${currentVisitor.purpose}\nTime: ${new Date().toLocaleString()}\n\nPlease come to reception.\n\n- PPC Reception`;

            let sent = false;

            // WhatsApp notification
            if (currentVisitor.hostPhone) {
                const whatsappUrl = `https://wa.me/${currentVisitor.hostPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                sent = true;
            }

            // Email notification
            if (currentVisitor.hostEmail) {
                const subject = `Visitor Alert: ${currentVisitor.fullName} from ${currentVisitor.company}`;
                const mailtoUrl = `mailto:${currentVisitor.hostEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
                window.location.href = mailtoUrl;
                sent = true;
            }

            if (sent) {
                alert('‚úÖ Notification sent to host!');
            }
        }

        // Quick check-in
        async function quickCheckin() {
            const search = document.getElementById('quickSearch').value.trim().toLowerCase();
            if (!search) {
                alert('Please enter a name or phone number');
                return;
            }
        
            await loadVisitors(); // Refresh data
            const previousVisitor = allVisitors.find(v => 
                String(v.Phone).includes(search) || 
                v['Full Name'].toLowerCase().includes(search)
            );
        
            if (!previousVisitor) {
                document.getElementById('quickResult').innerHTML = `
                    <div class="visitor-item" style="border-left-color: var(--warning);">
                        <p style="color: var(--warning);">‚ùå No previous visit found.</p>
                        <p style="color: var(--text-dim); margin-top: 0.5rem;">Please use the "New Visitor" tab to register.</p>
                    </div>
                `;
                return;
            }
        
            // Create new visit with previous visitor data
            const hostSelect = document.getElementById('hostName');
            const hostOption = Array.from(hostSelect.options).find(opt => opt.value === previousVisitor['Host Name']);
            
            const visitor = {
                fullName: previousVisitor['Full Name'],
                company: previousVisitor.Company,
                phone: previousVisitor.Phone,
                email: previousVisitor.Email || '',
                hostName: previousVisitor['Host Name'],
                hostPhone: hostOption ? hostOption.getAttribute('data-phone') : '',
                hostEmail: hostOption ? hostOption.getAttribute('data-email') : '',
                hostCompany: 'Plastic Powder Coating Company LLC',
                purpose: previousVisitor.Purpose,
                vehicle: previousVisitor.Vehicle || '',
                id: 'VIS-' + Date.now(),
                checkInTime: new Date().toISOString(),
                checkOutTime: '',
                status: 'IN'
            };
        
            try {
                await syncToCloud(visitor);
                currentVisitor = visitor;
                
                document.getElementById('quickResult').innerHTML = `
                    <div class="visitor-item">
                        <h3>${visitor.fullName}</h3>
                        <div class="visitor-details">
                            <p><strong>Company:</strong> ${visitor.company}</p>
                            <p><strong>Visiting:</strong> ${visitor.hostName}</p>
                            <p style="color: var(--accent); margin-top: 1rem;">‚úÖ Checked in successfully!</p>
                        </div>
                        <button onclick="generateBadge(currentVisitor)" class="btn btn-block" style="margin-top: 1rem;">
                            Generate Badge
                        </button>
                    </div>
                `;
                await loadVisitors();
            } catch (error) {
                console.error('Quick check-in error:', error);
                alert('‚ùå Check-in failed. Please try again.');
            }
        }

        // Display checkout list
        async function displayCheckoutList() {
            await loadVisitors();
            const currentVisitors = allVisitors.filter(v => v.Status === 'IN');
            const listDiv = document.getElementById('checkoutList');

            if (currentVisitors.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 2rem;">No visitors currently checked in</p>';
                return;
            }

            listDiv.innerHTML = currentVisitors.map(v => {
                // Handle property names with spaces
                const date = v['Date '] || v['Date'] || v.Date || 'N/A';
                const time = v[' Check-In Time'] || v['Check-In Time'] || '';
                
                // Format time if in ISO format
                let displayTime = time;
                if (time && time.includes('T')) {
                    const timeObj = new Date(time);
                    displayTime = timeObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                return `
                    <div class="visitor-item">
                        <h3>${v['Full Name']}</h3>
                        <div class="visitor-details">
                            <p><strong>Company:</strong> ${v.Company}</p>
                            <p><strong>Phone:</strong> ${v.Phone}</p>
                            <p><strong>Check-In:</strong> ${date} ${displayTime}</p>
                        </div>
                        <button onclick="checkoutVisitor('${v['Visitor ID']}')" class="btn btn-block" style="margin-top: 1rem;">
                            Check Out
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Search for checkout
        function searchForCheckout() {
            const query = document.getElementById('searchCheckout').value.toLowerCase().trim();
            
            if (!query) {
                displayCheckoutList();
                return;
            }
            
            const currentVisitors = allVisitors.filter(v => 
                v.Status === 'IN' && 
                (v['Full Name'].toLowerCase().includes(query) || 
                 String(v.Phone).includes(query) ||
                 v['Visitor ID'].toLowerCase().includes(query))
            );
        
            const listDiv = document.getElementById('checkoutList');
        
            if (currentVisitors.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-dim); text-align: center; padding: 2rem;">No matching visitors</p>';
                return;
            }
        
            listDiv.innerHTML = currentVisitors.map(v => {
                // Handle property names with spaces
                const date = v['Date '] || v['Date'] || v.Date || 'N/A';
                const time = v[' Check-In Time'] || v['Check-In Time'] || '';
                
                // Format time if in ISO format
                let displayTime = time;
                if (time && time.includes('T')) {
                    const timeObj = new Date(time);
                    displayTime = timeObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
                
                return `
                    <div class="visitor-item">
                        <h3>${v['Full Name']}</h3>
                        <div class="visitor-details">
                            <p><strong>Company:</strong> ${v.Company}</p>
                            <p><strong>Phone:</strong> ${v.Phone}</p>
                            <p><strong>Visitor ID:</strong> ${v['Visitor ID']}</p>
                            <p><strong>Check-In:</strong> ${date} ${displayTime}</p>
                        </div>
                        <button onclick="checkoutVisitor('${v['Visitor ID']}')" class="btn btn-block" style="margin-top: 1rem;">
                            Check Out
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Checkout visitor
        async function checkoutVisitor(visitorId) {
            if (!confirm('Check out this visitor?')) return;

            try {
                const checkoutTime = new Date().toLocaleTimeString('en-US', { hour12: false });
                const response = await fetch(`${WEB_APP_URL}?action=checkout&visitorId=${visitorId}&checkoutTime=${checkoutTime}`);
                
                alert('‚úÖ Visitor checked out successfully!');
                await loadVisitors();
                displayCheckoutList();
            } catch (error) {
                console.error('Checkout error:', error);
                alert('‚ùå Checkout failed. Please try again.');
            }
        }
        // Email badge to visitor
        function emailVisitor() {
            let email = currentVisitor.email;
            
            // If no email, ask for it
            if (!email) {
                email = prompt('Enter visitor email address:');
                if (!email) {
                    alert('‚ö†Ô∏è Email address required to send badge.');
                    return;
                }
                // Validate email format
                if (!email.includes('@')) {
                    alert('‚ö†Ô∏è Please enter a valid email address.');
                    return;
                }
            }
            
            const subject = `Your Visitor Badge - ${currentVisitor.fullName}`;
            const body = `Dear ${currentVisitor.fullName},\n\nThank you for visiting Plastic Powder Coating Company LLC.\n\nYour Visitor ID: ${currentVisitor.id}\nCheck-In Time: ${new Date(currentVisitor.checkInTime).toLocaleString()}\n\nPlease keep this email for your records.\n\nBest regards,\nPPC Reception`;
            
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }
        
        // Send badge to visitor's mobile
        function sendToVisitorMobile() {
            let phone = currentVisitor.phone;
            
            // If no phone, ask for it
            if (!phone) {
                phone = prompt('Enter visitor phone number (with country code):');
                if (!phone) {
                    alert('‚ö†Ô∏è Phone number required to send badge.');
                    return;
                }
            }
            
            const message = `Thank you for visiting PPC!\n\nYour Visitor ID: ${currentVisitor.id}\nCheck-In: ${new Date(currentVisitor.checkInTime).toLocaleString()}\n\nPlease show this message when leaving.\n\n- PPC Reception`;
            
            // Convert phone to string and remove non-digits
            const cleanPhone = String(phone).replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Close modal
        function closeModal() {
            document.getElementById('badgeModal').classList.remove('active');
        }
        
        // QR Scanner Variables
        let qrStream = null;
        let qrCanvas = null;
        let qrContext = null;
        let qrScanning = false;

        // Start QR Scanner
        async function startQRScanner() {
            const video = document.getElementById('qrVideo');
            const scannerDiv = document.getElementById('qrScanner');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            
            try {
                // Request camera permission
                qrStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Use back camera on mobile
                });
                
                video.srcObject = qrStream;
                video.setAttribute('playsinline', true); // Required for iOS
                video.play();
                
                scannerDiv.style.display = 'block';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                
                // Create canvas for QR detection
                qrCanvas = document.createElement('canvas');
                qrContext = qrCanvas.getContext('2d');
                
                qrScanning = true;
                requestAnimationFrame(scanQRCode);
                
            } catch (error) {
                console.error('Camera error:', error);
                alert('‚ùå Unable to access camera.\n\nPlease:\n1. Allow camera permissions\n2. Use HTTPS connection\n3. Try using manual search instead');
            }
        }

        // Stop QR Scanner
        function stopQRScanner() {
            const video = document.getElementById('qrVideo');
            const scannerDiv = document.getElementById('qrScanner');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            
            qrScanning = false;
            
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
            
            video.srcObject = null;
            scannerDiv.style.display = 'none';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
        }

        // Scan QR Code
        function scanQRCode() {
            const video = document.getElementById('qrVideo');
            
            if (!qrScanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
                if (qrScanning) {
                    requestAnimationFrame(scanQRCode);
                }
                return;
            }
            
            qrCanvas.height = video.videoHeight;
            qrCanvas.width = video.videoWidth;
            qrContext.drawImage(video, 0, 0, qrCanvas.width, qrCanvas.height);
            
            const imageData = qrContext.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: 'dontInvert',
            });
            
            if (code && code.data) {
                // QR code detected!
                const visitorId = code.data;
                console.log('QR Code scanned:', visitorId);
                
                // Stop scanner
                stopQRScanner();
                
                // Find and checkout visitor
                checkoutByVisitorId(visitorId);
                
                return;
            }
            
            if (qrScanning) {
                requestAnimationFrame(scanQRCode);
            }
        }

        // Checkout by Visitor ID (from QR scan)
        async function checkoutByVisitorId(visitorId) {
            await loadVisitors();
            const visitor = allVisitors.find(v => v['Visitor ID'] === visitorId && v.Status === 'IN');
            
            if (!visitor) {
                alert('‚ùå Visitor not found or already checked out.\n\nVisitor ID: ' + visitorId);
                return;
            }
            
            // Show confirmation with visitor details
            const confirmMsg = `Check out this visitor?\n\n` +
                `Name: ${visitor['Full Name']}\n` +
                `Company: ${visitor.Company}\n` +
                `Check-In: ${visitor.Date || 'N/A'} ${visitor['Check-In Time'] || ''}`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                const checkoutTime = new Date().toLocaleTimeString('en-US', { hour12: false });
                await fetch(`${WEB_APP_URL}?action=checkout&visitorId=${visitorId}&checkoutTime=${checkoutTime}`);
                
                alert('‚úÖ Visitor checked out successfully!\n\n' + visitor['Full Name']);
                await loadVisitors();
                displayCheckoutList();
            } catch (error) {
                console.error('Checkout error:', error);
                alert('‚ùå Checkout failed. Please try again.');
            }
        }
    </script>
</body>
</html>
